<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç®—è¨­å®šå•é¡Œè¨ºæ–·</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .diagnostic-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-btn {
            margin: 5px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
        }
        .test-btn:hover {
            background: #f0f0f0;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
    </style>
</head>
<body data-theme="cuteCats">
    <div class="diagnostic-container">
        <h1>é ç®—è¨­å®šèƒŒæ™¯åœ–ç‰‡å•é¡Œè¨ºæ–·</h1>
        
        <div class="section">
            <h3>æ­¥é©Ÿ 1: æª¢æŸ¥CSSè¼‰å…¥</h3>
            <button class="test-btn" onclick="checkCSSLoading()">æª¢æŸ¥CSSæ–‡ä»¶è¼‰å…¥</button>
            <div id="cssLoadingOutput" class="output"></div>
        </div>
        
        <div class="section">
            <h3>æ­¥é©Ÿ 2: æª¢æŸ¥ä¸»é¡ŒCSSè¦å‰‡</h3>
            <button class="test-btn" onclick="checkThemeCSSRules()">æª¢æŸ¥ä¸»é¡ŒCSSè¦å‰‡</button>
            <div id="themeCSSOutput" class="output"></div>
        </div>
        
        <div class="section">
            <h3>æ­¥é©Ÿ 3: æ¸¬è©¦é ç®—è¨­å®šæ¨¡æ…‹æ¡†</h3>
            <button class="test-btn" onclick="testBudgetModal()">æ¸¬è©¦é ç®—è¨­å®šæ¨¡æ…‹æ¡†</button>
            <button class="test-btn" onclick="simulateRealBudgetModal()">æ¨¡æ“¬çœŸå¯¦é ç®—è¨­å®š</button>
            <div id="budgetModalOutput" class="output"></div>
        </div>
        
        <div class="section">
            <h3>æ­¥é©Ÿ 4: æª¢æŸ¥JavaScriptå¹²æ“¾</h3>
            <button class="test-btn" onclick="checkJSInterference()">æª¢æŸ¥JavaScriptå¹²æ“¾</button>
            <button class="test-btn" onclick="monitorStyleChanges()">ç›£æ§æ¨£å¼è®ŠåŒ–</button>
            <div id="jsInterferenceOutput" class="output"></div>
        </div>
        
        <div class="section">
            <h3>æ¸¬è©¦å€åŸŸ</h3>
            <div id="testArea"></div>
        </div>
    </div>
    
    <script>
        // æ¨¡æ“¬çœŸçœŸå¯¦çš„é ç®—è¨­å®šå‡½æ•¸
        function simulateRealBudgetModal() {
            const budgets = JSON.parse(localStorage.getItem('categoryBudgets') || '{}');
            const categoryName = 'é¤é£²';
            const currentBudget = budgets[categoryName] || 0;
            const categoryIcon = 'ğŸ½ï¸';
            
            // å‰µå»ºé ç®—è¨­å®šæ¨¡æ…‹æ¡† - å®Œå…¨æŒ‰ç…§çœŸå¯¦ä»£ç¢¼
            const budgetModal = document.createElement('div');
            budgetModal.className = 'budget-setting-modal';
            
            budgetModal.innerHTML = `
                <div class="budget-setting-modal-content" style="border-radius: 24px; padding: 28px; max-width: 420px; width: 100%; box-shadow: var(--shadow-primary-lg), 0 4px 16px rgba(0, 0, 0, 0.15); border: 1px solid var(--color-primary-rgba-20); animation: slideIn 0.3s ease-out;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 28px;">${categoryIcon}</span>
                            <span>è¨­å®šé ç®—</span>
                        </h2>
                        <button class="budget-setup-close-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-tertiary); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;">Ã—</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-gradient-light); border-radius: 12px; border: 1px solid var(--color-primary-rgba-20);">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">åˆ†é¡åç¨±</div>
                        <div style="font-size: 18px; color: var(--color-primary-dark); font-weight: 600;">
                            ${categoryName}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label for="budgetAmountInput" style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">é ç®—é‡‘é¡ <span style="font-size: 12px; font-weight: normal; color: var(--text-tertiary);">(è¼¸å…¥ 0 å¯åˆªé™¤é ç®—)</span></label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: 600; font-size: 16px;">NT$</span>
                            <input type="number" id="budgetAmountInput" value="${currentBudget}" step="0.01" min="0" placeholder="è«‹è¼¸å…¥é ç®—é‡‘é¡" class="budget-amount-input" style="width: 100%; padding: 14px 16px 14px 60px; border: 2px solid var(--border-light); border-radius: 12px; font-size: 18px; font-weight: 600; background: var(--bg-white); color: var(--text-primary); transition: all 0.3s; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button id="budgetSetupCancelBtn" class="budget-setup-cancel-btn" style="flex: 1; padding: 14px; border: 2px solid var(--border-light); border-radius: 12px; background: var(--bg-white); color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;">å–æ¶ˆ</button>
                        <button id="budgetSetupSaveBtn" class="budget-setup-save-btn" style="flex: 2; padding: 14px; border: none; border-radius: 12px; background: var(--bg-gradient); color: var(--text-white); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow-primary);">å„²å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(budgetModal);
            
            // æª¢æŸ¥å‰µå»ºå¾Œçš„æ¨£å¼
            setTimeout(() => {
                const modalContent = budgetModal.querySelector('.budget-setting-modal-content');
                if (modalContent) {
                    const computedStyle = window.getComputedStyle(modalContent);
                    const output = document.getElementById('budgetModalOutput');
                    
                    const hasBackgroundImage = computedStyle.backgroundImage.includes('956499812b93c3c5bf8226051c7e627f');
                    
                    output.innerHTML = `
<span class="${hasBackgroundImage ? 'success' : 'error'}">é ç®—è¨­å®šæ¨¡æ…‹æ¡†å‰µå»ºæˆåŠŸ</span>

=== å‰µå»ºå¾Œçš„æ¨£å¼æª¢æŸ¥ ===
èƒŒæ™¯åœ–ç‰‡: ${hasBackgroundImage ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}
å¯¦éš›èƒŒæ™¯: ${computedStyle.backgroundColor}
èƒŒæ™¯åœ–ç‰‡URL: ${computedStyle.backgroundImage}
æ··åˆæ¨¡å¼: ${computedStyle.backgroundBlendMode}
æ¯›ç»ç’ƒ: ${computedStyle.backdropFilter}

=== å…§è¯æ¨£å¼æª¢æŸ¥ ===
å…ƒç´ æœ‰å…§è¯æ¨£å¼: ${modalContent.hasAttribute('style') ? 'æ˜¯' : 'å¦'}
å…§è¯æ¨£å¼å…§å®¹: ${modalContent.getAttribute('style') || 'ç„¡'}

=== å•é¡Œè¨ºæ–· ===
${hasBackgroundImage ? 
    'âœ… CSSæ¨£å¼æ­£ç¢ºæ‡‰ç”¨ï¼ŒèƒŒæ™¯åœ–ç‰‡é¡¯ç¤ºæ­£å¸¸' : 
    'âŒ CSSæ¨£å¼æœªæ­£ç¢ºæ‡‰ç”¨ï¼Œéœ€è¦é€²ä¸€æ­¥èª¿æŸ¥'}
                    `;
                    
                    // 5ç§’å¾Œè‡ªå‹•é—œé–‰
                    setTimeout(() => {
                        if (document.body.contains(budgetModal)) {
                            document.body.removeChild(budgetModal);
                        }
                    }, 5000);
                }
            }, 100);
        }
        
        function checkCSSLoading() {
            const output = document.getElementById('cssLoadingOutput');
            
            // æª¢æŸ¥CSSæ–‡ä»¶æ˜¯å¦è¼‰å…¥
            const stylesheets = document.styleSheets;
            let cssLoaded = false;
            let cssInfo = [];
            
            for (let i = 0; i < stylesheets.length; i++) {
                const sheet = stylesheets[i];
                if (sheet.href && sheet.href.includes('styles.css')) {
                    cssLoaded = true;
                    cssInfo.push(`âœ… styles.css è¼‰å…¥æˆåŠŸ: ${sheet.href}`);
                    break;
                }
            }
            
            if (!cssLoaded) {
                cssInfo.push('âŒ styles.css æœªæ‰¾åˆ°æˆ–æœªè¼‰å…¥');
            }
            
            // æª¢æŸ¥CSSè¦å‰‡æ•¸é‡
            try {
                const rules = document.styleSheets[0].cssRules;
                cssInfo.push(`CSSè¦å‰‡æ•¸é‡: ${rules.length}`);
                
                // æª¢æŸ¥é ç®—è¨­å®šç›¸é—œè¦å‰‡
                let budgetRules = 0;
                for (let i = 0; i < rules.length; i++) {
                    const rule = rules[i];
                    if (rule.selectorText && rule.selectorText.includes('budget-setting-modal-content')) {
                        budgetRules++;
                    }
                }
                cssInfo.push(`é ç®—è¨­å®šç›¸é—œè¦å‰‡: ${budgetRules}`);
            } catch (e) {
                cssInfo.push(`âŒ ç„¡æ³•æª¢æŸ¥CSSè¦å‰‡: ${e.message}`);
            }
            
            output.innerHTML = cssInfo.join('\n');
        }
        
        function checkThemeCSSRules() {
            const output = document.getElementById('themeCSSOutput');
            const theme = document.body.getAttribute('data-theme');
            
            // æª¢æŸ¥ç•¶å‰ä¸»é¡Œçš„æ‰€æœ‰CSSè¦å‰‡
            let themeRules = [];
            
            for (let i = 0; i < document.styleSheets.length; i++) {
                try {
                    const sheet = document.styleSheets[i];
                    if (sheet.cssRules) {
                        for (let j = 0; j < sheet.cssRules.length; j++) {
                            const rule = sheet.cssRules[j];
                            if (rule.selectorText && 
                                rule.selectorText.includes(`data-theme="${theme}"`) &&
                                rule.selectorText.includes('budget-setting-modal-content')) {
                                themeRules.push({
                                    selector: rule.selectorText,
                                    style: rule.style.cssText
                                });
                            }
                        }
                    }
                } catch (e) {
                    // è·¨åŸŸæ¨£å¼è¡¨ç„¡æ³•è¨ªå•
                }
            }
            
            if (themeRules.length === 0) {
                output.innerHTML = `<span class="error">âŒ æ²’æœ‰æ‰¾åˆ°ä¸»é¡Œ ${theme} çš„é ç®—è¨­å®šCSSè¦å‰‡</span>`;
            } else {
                let outputHtml = `<span class="success">âœ… æ‰¾åˆ° ${themeRules.length} å€‹ä¸»é¡ŒCSSè¦å‰‡</span>\n\n`;
                themeRules.forEach((rule, index) => {
                    outputHtml += `è¦å‰‡ ${index + 1}:\n`;
                    outputHtml += `é¸æ“‡å™¨: ${rule.selector}\n`;
                    outputHtml += `æ¨£å¼: ${rule.style}\n\n`;
                });
                output.innerHTML = outputHtml;
            }
        }
        
        function testBudgetModal() {
            const testArea = document.getElementById('testArea');
            testArea.innerHTML = `
                <div class="budget-setting-modal-content" style="max-width: 400px; margin: 20px auto;">
                    <h3>ç°¡å–®æ¸¬è©¦</h3>
                    <p>é€™æ˜¯ä¸€å€‹ç°¡å–®çš„é ç®—è¨­å®šæ¨¡æ…‹æ¡†å…§å®¹æ¸¬è©¦ã€‚</p>
                </div>
            `;
            
            setTimeout(() => {
                const element = document.querySelector('.budget-setting-modal-content');
                if (element) {
                    const computedStyle = window.getComputedStyle(element);
                    const output = document.getElementById('budgetModalOutput');
                    
                    const hasBackgroundImage = computedStyle.backgroundImage.includes('956499812b93c3c5bf8226051c7e627f');
                    
                    output.innerHTML = `
<span class="${hasBackgroundImage ? 'success' : 'error'}">ç°¡å–®æ¸¬è©¦çµæœ</span>

=== è¨ˆç®—æ¨£å¼ ===
èƒŒæ™¯åœ–ç‰‡: ${hasBackgroundImage ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}
å¯¦éš›èƒŒæ™¯: ${computedStyle.backgroundColor}
èƒŒæ™¯åœ–ç‰‡URL: ${computedStyle.backgroundImage}
                    `;
                }
            }, 100);
        }
        
        function checkJSInterference() {
            const output = document.getElementById('jsInterferenceOutput');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰JavaScriptå¯èƒ½å¹²æ“¾
            let interference = [];
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å…¨å±€æ¨£å¼é‡ç½®
            if (window.getComputedStyle) {
                const testElement = document.createElement('div');
                testElement.className = 'budget-setting-modal-content';
                document.body.appendChild(testElement);
                
                const initialStyle = window.getComputedStyle(testElement);
                document.body.removeChild(testElement);
                
                interference.push(`åˆå§‹èƒŒæ™¯: ${initialStyle.backgroundColor}`);
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰CSSè®Šæ•¸å•é¡Œ
            if (getComputedStyle) {
                const rootStyle = getComputedStyle(document.documentElement);
                const primaryColor = rootStyle.getPropertyValue('--color-primary');
                interference.push(`ä¸»é¡Œè‰²è®Šæ•¸: ${primaryColor || 'æœªå®šç¾©'}`);
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰!importantè¦†è“‹å•é¡Œ
            interference.push('å»ºè­°æª¢æŸ¥CSSå„ªå…ˆç´šå’Œ!importantä½¿ç”¨æƒ…æ³');
            
            output.innerHTML = interference.join('\n');
        }
        
        function monitorStyleChanges() {
            const output = document.getElementById('jsInterferenceOutput');
            
            // å‰µå»ºæ¸¬è©¦å…ƒç´ 
            const testElement = document.createElement('div');
            testElement.className = 'budget-setting-modal-content';
            testElement.style.cssText = 'width: 200px; height: 100px; padding: 10px; margin: 10px; border: 1px solid #ccc;';
            document.getElementById('testArea').appendChild(testElement);
            
            let changes = [];
            let lastBackground = '';
            
            // ç›£æ§æ¨£å¼è®ŠåŒ–
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const currentStyle = testElement.getAttribute('style');
                        if (currentStyle !== lastBackground) {
                            changes.push(`æ¨£å¼è®ŠåŒ–: ${currentStyle}`);
                            lastBackground = currentStyle;
                            
                            // æ›´æ–°è¼¸å‡º
                            output.innerHTML = `ç›£æ§æ¨£å¼è®ŠåŒ–:\n${changes.join('\n')}`;
                        }
                    }
                });
            });
            
            observer.observe(testElement, { attributes: true, attributeFilter: ['style'] });
            
            // 5ç§’å¾Œåœæ­¢ç›£æ§
            setTimeout(() => {
                observer.disconnect();
                changes.push('ç›£æ§çµæŸ');
                output.innerHTML = `ç›£æ§æ¨£å¼è®ŠåŒ–:\n${changes.join('\n')}`;
            }, 5000);
            
            output.innerHTML = 'é–‹å§‹ç›£æ§æ¨£å¼è®ŠåŒ–...';
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(checkCSSLoading, 500);
        });
    </script>
</body>
</html>
